defmodule SpecTest do
  use PowerAssert
  doctest Chacha20
  import Chacha20

  @moduledoc """

  Test vectors from the specification RFC:

  https://tools.ietf.org/html/rfc7539

  """

  test "quarterround" do
    assert quarterround([0x11111111, 0x01020304, 0x9b8d6f43, 0x01234567]) == [0xea2a92f4, 0xcb1cf8ce, 0x4581472e, 0x5881c4bb]
  end

 test "expand" do
   k = <<0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31>>
   n = <<0,0,0,9,0,0,0,74,0,0,0,0>>
   b = 1

  assert expand(k,n,b) == [1634760805, 857760878, 2036477234, 1797285236, 50462976, 117835012, 185207048, 252579084, 319951120, 387323156, 454695192, 522067228, 1, 150994944, 1241513984, 0]

  end

  test "block" do
    k = <<0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31>>
    n = <<0,0,0,9,0,0,0,74,0,0,0,0>>
    b = 1

    assert block(k,n,b) == <<16,241,231,228,209,59,89,21,80,15,221,31,163,32,113,196,199,209,244,199,51,192,104,3,4,34,170,154,195,212,108,78,210,130,100,70,7,159,170,9,20,194,215,5,217,139,2,162,181,18,156,209,222,22,78,185,203,208,131,232,162,80,60,78>>
  end

  test "crypt" do
    k = <<0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31>>
    n = <<0,0,0,0,0,0,0,74,0,0,0,0>>
    m = "Ladies and Gentlemen of the class of '99: If I could offer you only one tip for the future, sunscreen would be it."

  assert expand(k,n,1) == [1634760805, 857760878, 2036477234, 1797285236, 50462976, 117835012, 185207048, 252579084, 319951120, 387323156, 454695192, 522067228, 1, 0, 1241513984, 0]
  assert expand(k,n,2) == [1634760805, 857760878, 2036477234, 1797285236, 50462976, 117835012, 185207048, 252579084, 319951120, 387323156, 454695192, 522067228, 2, 0, 1241513984, 0]
  assert crypt(m,k,n) == <<110, 46, 53, 154, 37, 104, 249, 128, 65, 186, 7, 40, 221, 13, 105, 129, 233, 126, 122, 236, 29, 67, 96, 194, 10, 39, 175, 204, 253, 159, 174, 11, 249, 27, 101, 197, 82, 71, 51, 171, 143, 89, 61, 171, 205, 98, 179, 87, 22, 57, 214,36,230,81,82,171,143,83,12,53,159,8,97,216,7, 202, 13, 191, 80, 13, 106, 97, 86, 163, 142, 8, 138, 34, 182, 94,82, 188, 81, 77, 22, 204, 248, 6, 129, 140, 233, 26, 183, 121, 55, 54,90, 249, 11, 191, 116, 163, 91, 230, 180, 11, 142, 237, 242, 120, 94, 66,135,77>>
  end

end
